# 微信登录功能测试指南

## 快速测试步骤

### 1. 在微信开发者工具中测试

#### 步骤1：打开项目
1. 使用微信开发者工具打开项目
2. 确保 AppID 已正确配置为：`wx30bc2e148f3356a8`

#### 步骤2：测试登录流程
1. 打开首页（index页面）
2. 点击顶部的用户头像区域
3. 应该弹出登录提示框："您还未登录"
4. 点击"立即登录"按钮
5. 在开发者工具中会弹出授权确认
6. 确认授权后，查看控制台日志

#### 步骤3：查看控制台日志
应该看到以下日志输出：
```
用户信息获取成功: {...}
微信登录成功，code: 071xxx...
获取到登录凭证: 071xxx...
登录成功
```

#### 步骤4：验证登录状态
1. 登录成功后，头像应该显示用户的微信头像
2. 昵称应该显示用户的微信昵称
3. 再次点击头像，应该跳转到个人中心页面（my/index）

### 2. 查看存储的数据

在开发者工具的 Storage 面板中，查看 `userInfo` 数据：

```javascript
{
  "avatarUrl": "https://thirdwx.qlogo.cn/...",
  "nickName": "用户昵称",
  "wechatCode": "071xxx...",
  "loginTime": 1697270400000
}
```

### 3. 测试场景

#### 场景1：未登录状态
- 点击头像 → 显示登录弹窗
- 点击"暂不登录" → 关闭弹窗
- 点击"立即登录" → 获取授权并登录

#### 场景2：已登录状态
- 点击头像 → 跳转个人中心
- 退出登录后 → 清除 Storage 中的 userInfo
- 再次点击头像 → 显示登录弹窗

#### 场景3：拒绝授权
- 点击"立即登录"
- 拒绝授权
- 登录弹窗应该关闭
- 用户仍然是未登录状态

### 4. 调试技巧

#### 查看详细日志
在 `pages/index/index.js` 中，各个关键步骤都有 console.log 输出：
- `用户信息获取成功` - 获取微信用户信息
- `微信登录成功，code:` - 获取到登录凭证
- `获取到登录凭证` - 准备处理登录
- `登录成功` - 整个流程完成

#### 清除登录状态测试
在控制台执行：
```javascript
wx.removeStorageSync('userInfo')
```
然后刷新页面，可以重新测试登录流程

#### 检查 Bmob 集成
如果项目使用了 Bmob 后端：
- 确保 Bmob 初始化正常
- 检查 `wx.u.getUserInfo()` 是否正常工作
- 如果 Bmob 失败，会自动降级到本地存储

### 5. 常见问题排查

#### 问题1：点击"立即登录"没有反应
- 检查控制台是否有错误信息
- 确认微信开发者工具版本是否支持 getUserProfile

#### 问题2：获取不到用户信息
- 检查是否同意了授权
- 确认网络连接正常
- 查看控制台错误信息

#### 问题3：code 为空
- 检查 AppID 配置是否正确
- 确认网络连接正常
- 查看微信开发者工具的网络面板

#### 问题4：登录成功但头像不显示
- 检查 Storage 中是否保存了 avatarUrl
- 确认图片 URL 有效
- 查看网络面板图片请求是否成功

### 6. 真机测试准备

在真机上测试前，需要：

1. **配置服务器域名**
   在微信公众平台 → 开发 → 开发管理 → 开发设置 → 服务器域名中配置：
   - request合法域名：`https://api.weixin.qq.com`
   
2. **上传体验版**
   - 在开发者工具点击"上传"
   - 在微信公众平台设置为体验版
   - 使用微信扫码体验

3. **真机测试要点**
   - 首次使用需要授权
   - 检查登录流程是否流畅
   - 验证数据存储是否正常

### 7. 性能检查

- 登录过程应该在 2-3 秒内完成
- 没有明显的卡顿
- Loading 提示正常显示和隐藏

### 8. 安全检查

⚠️ **生产环境部署前必须检查**：
1. AppSecret 是否已移到后端服务器
2. 是否通过后端 API 换取 openid
3. 是否有 session 有效期管理
4. 用户敏感信息是否加密存储

## 测试清单

- [ ] 点击头像显示登录弹窗
- [ ] 点击"暂不登录"可关闭弹窗
- [ ] 点击"立即登录"可获取授权
- [ ] 授权后显示"登录成功"提示
- [ ] 头像和昵称正确显示
- [ ] 登录信息保存到 Storage
- [ ] 已登录状态点击头像跳转个人中心
- [ ] 拒绝授权可正常处理
- [ ] 控制台无错误日志
- [ ] 新旧版本登录方式都正常工作

## 下一步

测试通过后，建议：
1. 开发后端 API 接收 code
2. 实现 code 换取 openid 的后端逻辑
3. 实现登录态管理
4. 添加自动登录功能
5. 完善错误处理和用户提示

